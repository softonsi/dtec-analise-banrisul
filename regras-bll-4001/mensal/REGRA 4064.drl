/*mensal*/ 
SELECT T.CD_DOC_IDENTF_CLIE, T.CD_TP_IDENTF_CLIE, 
(SELECT 'Análise: Regra ' || TO_CHAR(CD_REGRA) || ' - ' || NM_REGRA || '| Objetivo: ' || DS_REGRA || '|' FROM TB_REGRA WHERE CD_REGRA = 4064 AND CD_VERSAO_SISTEMA = 4) || 
'Cliente: ' || T.NM_CLIE || '|' || 
CASE T.CD_TP_IDENTF_CLIE 
     WHEN 2 THEN 'Tipo de Pessoa Física (CPF): ' || SUBSTR(T.CD_DOC_IDENTF_CLIE, 1, 3) || '.' || SUBSTR(T.CD_DOC_IDENTF_CLIE, 4, 3) || '.' || SUBSTR(T.CD_DOC_IDENTF_CLIE, 7, 3) || '-' || SUBSTR(T.CD_DOC_IDENTF_CLIE, 10, 2) 
     WHEN 3 THEN 'Tipo de Pessoa Jurídica (CNPJ): ' || SUBSTR(T.CD_DOC_IDENTF_CLIE, 1, 2) || '.' || SUBSTR(T.CD_DOC_IDENTF_CLIE, 3, 3) || '.' || SUBSTR(T.CD_DOC_IDENTF_CLIE, 6, 3) || '/' || SUBSTR(T.CD_DOC_IDENTF_CLIE, 9, 4) || '-'  || SUBSTR(T.CD_DOC_IDENTF_CLIE, 13, 2) 
     ELSE T.CD_DOC_IDENTF_CLIE 
END 
 || '|' ||  
'Mês calendário: ' || SUBSTR(T.CD_MES_ANO, 5, 2) || '/' || SUBSTR(T.CD_MES_ANO, 1, 4) || '|' ||  
CASE T.CD_NATUR_OPER  
WHEN 1 THEN 'Natureza da operação: Crédito' 
WHEN 2 THEN 'Natureza da operação: Débito' 
END 
 || '|' ||  
'Valor consolidado no mês calendário: ' || TO_CHAR(VL_TOTAL, 'L999G999G999G990D99') || '|' || 
'Valor médio em 6 meses: ' || TO_CHAR(VL_MEDIO, 'L999G999G999G990D99') || '|' || 
CASE T.CD_NATUR_OPER  
WHEN 1 THEN COALESCE((':DS-pm_percMedioCredito' || ' (' || ':NM-pm_percMedioCredito' || '):' || TO_CHAR(:pm_percMedioCredito) || '%'),'Parâmetro não cadastrado' ) || '|'      
WHEN 2 THEN COALESCE((':DS-pm_percMedioDebito' || ' (' || ':NM-pm_percMedioDebito' || '):' || TO_CHAR(:pm_percMedioDebito) || '%'),'Parâmetro não cadastrado' ) || '|'     
END 
AS DS_INF_ANLSE   
FROM 
(  
SELECT A.CD_MES_ANO, A.CD_DOC_IDENTF_CLIE, A.CD_TP_IDENTF_CLIE, A.NM_CLIE, A.CD_LOTE, A.CD_TP_PESSOA, A.CD_RAMO_ATIVID, A.CD_NATUR_OPER, A.VL_TOTAL, A.QT_TOTAL, A.VL_MEDIO 
FROM 
(SELECT A.CD_MES_ANO, A.CD_DOC_IDENTF_CLIE, A.CD_TP_IDENTF_CLIE, A.NM_CLIE, A.CD_LOTE, A.CD_TP_PESSOA, A.CD_RAMO_ATIVID, A.CD_NATUR_OPER, A.VL_TOTAL, A.QT_TOTAL, (SUM(MEDIA.VL_TOTAL)/6) VL_MEDIO 
 FROM  
 (SELECT CD_MES_ANO, CD_DOC_IDENTF_CLIE, CD_TP_IDENTF_CLIE, NM_CLIE, CD_LOTE, CD_TP_PESSOA, CD_RAMO_ATIVID, CD_NATUR_OPER, SUM(VL_OPER) VL_TOTAL, COUNT(*) QT_TOTAL 
  FROM TB_TRANS 
  WHERE CD_NATUR_OPER IN (1,2)   
    AND DT_TRANS >= to_date(to_char(:cd_lote), 'yyyy/mm')  
    AND DT_TRANS < add_months((to_date(to_char(:cd_lote), 'yyyy/mm')), 1) 
  GROUP BY CD_MES_ANO, CD_DOC_IDENTF_CLIE, CD_TP_IDENTF_CLIE, NM_CLIE, CD_LOTE, CD_TP_PESSOA, CD_RAMO_ATIVID, CD_NATUR_OPER 
  ) A 
INNER JOIN TB_PERFIL_MES_CALENDARIO MEDIA  
ON MEDIA.CD_IDENTF_PERFIL = 105 AND MEDIA.CD_VARIAVEL_PRIMEIRA = A.CD_DOC_IDENTF_CLIE AND MEDIA.CD_VARIAVEL_SEGUNDA = A.CD_TP_IDENTF_CLIE AND MEDIA.CD_VARIAVEL_TERCEIRA = A.CD_NATUR_OPER AND MEDIA.CD_ANO_MES <> CD_MES_ANO   
GROUP BY A.CD_MES_ANO, A.CD_DOC_IDENTF_CLIE, A.CD_TP_IDENTF_CLIE, A.NM_CLIE, A.CD_LOTE, A.CD_TP_PESSOA, A.CD_RAMO_ATIVID, A.CD_NATUR_OPER, A.VL_TOTAL, A.QT_TOTAL 
) A 
WHERE ( 
(CD_TP_PESSOA = 'J'  
AND EXISTS (SELECT 1 FROM TB_RAMO_ATIVID R WHERE R.CD_RAMO_ATIVID = A.CD_RAMO_ATIVID AND FL_OPER_ITEM_LUXO = 1) 
AND 
((CD_NATUR_OPER = 1 AND 
 VL_TOTAL >= (VL_MEDIO * (:pm_percMedioCredito)) 
 ) 
 OR 
(CD_NATUR_OPER = 2 AND 
 VL_TOTAL >= (VL_MEDIO * (:pm_percMedioDebito)) 
))) 
OR 
(CD_TP_PESSOA = 'F'  
AND EXISTS  
(SELECT 1  
 FROM TB_CLIE_RENDA C  
 INNER JOIN TB_OCUP R ON R.CD_OCUP = C.CD_OCUP AND R.FL_OPER_ITEM_LUXO = 1 
 WHERE C.CD_DOC_IDENTF_CLIE = A.CD_DOC_IDENTF_CLIE  
   AND C.CD_TP_IDENTF_CLIE = A.CD_TP_IDENTF_CLIE 
 ) 
AND 
((CD_NATUR_OPER = 1 AND 
 VL_TOTAL >= (VL_MEDIO * (:pm_percMedioCredito)) 
 ) 
 OR 
(CD_NATUR_OPER = 2 AND 
 VL_TOTAL >= (VL_MEDIO * (:pm_percMedioDebito)) 
 ))) 
) 
) T 
 