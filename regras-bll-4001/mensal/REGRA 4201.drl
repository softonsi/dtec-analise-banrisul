/*MENSAL*/  
SELECT T.CD_DOC_IDENTF_CLIE, T.CD_TP_IDENTF_CLIE,  
(SELECT 'Análise: Regra ' || TO_CHAR(CD_REGRA) || ' - ' || NM_REGRA || '| Objetivo: ' || DS_REGRA || '|' FROM TB_REGRA WHERE CD_REGRA = 4201 AND CD_VERSAO_SISTEMA = 4) ||  
'Cliente: ' || T.NM_CLIE || '|' ||  
CASE T.CD_TP_IDENTF_CLIE  
     WHEN 2 THEN 'Tipo de Pessoa Física (CPF): ' || SUBSTR(T.CD_DOC_IDENTF_CLIE, 1, 3) || '.' || SUBSTR(T.CD_DOC_IDENTF_CLIE, 4, 3) || '.' || SUBSTR(T.CD_DOC_IDENTF_CLIE, 7, 3) || '-' || SUBSTR(T.CD_DOC_IDENTF_CLIE, 10, 2)  
     WHEN 3 THEN 'Tipo de Pessoa Jurídica (CNPJ): ' || SUBSTR(T.CD_DOC_IDENTF_CLIE, 1, 2) || '.' || SUBSTR(T.CD_DOC_IDENTF_CLIE, 3, 3) || '.' || SUBSTR(T.CD_DOC_IDENTF_CLIE, 6, 3) || '/' || SUBSTR(T.CD_DOC_IDENTF_CLIE, 9, 4) || '-'  || SUBSTR(T.CD_DOC_IDENTF_CLIE, 13, 2)  
     ELSE T.CD_DOC_IDENTF_CLIE  
END  
 || '|' ||   
'Mês calendário: ' || SUBSTR(T.CD_MES_ANO,5,2) || '/' || SUBSTR(T.CD_MES_ANO,1,4) ||  '|' ||      
CASE FL_PARTIDO        WHEN 1 THEN 'Partido identificado: Sim|'     END ||  
CASE FL_CANDIDATO_CNPJ WHEN 1 THEN 'Candidatos políticos PJ: Sim|'  END  
AS DS_INF_ANLSE    
FROM (SELECT T.CD_MES_ANO, T.CD_DOC_IDENTF_CLIE, T.CD_TP_IDENTF_CLIE, MAX(T.NM_CLIE) NM_CLIE,  
      CASE WHEN MAX(PI.DS_CONTEUDO)  IS NOT NULL THEN 1 ELSE 0 END FL_PARTIDO, 
      CASE WHEN MAX(CPJ.DS_CONTEUDO) IS NOT NULL THEN 1 ELSE 0 END FL_CANDIDATO_CNPJ 
      FROM TB_TRANS T  
      LEFT JOIN TB_CONTEUDO_LISTA_AUXILIAR  PI ON PI.CD_LISTA_AUXILIAR  = 114 AND TRIM(PI.DS_CONTEUDO)  = T.CD_DOC_IDENTF_CLIE    /*Partidos_identificacao*/       
      LEFT JOIN TB_CONTEUDO_LISTA_AUXILIAR CPJ ON CPJ.CD_LISTA_AUXILIAR = 115 AND TRIM(CPJ.DS_CONTEUDO) = T.CD_DOC_IDENTF_CLIE    /*CandidatosCNPJ_identificacao*/       
      WHERE T.DT_TRANS >= TO_DATE(:cd_lote || '01','YYYYMMDD') 
      AND T.DT_TRANS <=  LAST_DAY(TO_DATE(:cd_lote || '01','YYYYMMDD'))       
      AND T.CD_TP_PESSOA = 'J' 
      AND T.FL_ANALISADO = 1   
      GROUP BY T.CD_MES_ANO, T.CD_DOC_IDENTF_CLIE, T.CD_TP_IDENTF_CLIE 
     ) T  
WHERE T.FL_PARTIDO = 1  
OR FL_CANDIDATO_CNPJ = 1  
 