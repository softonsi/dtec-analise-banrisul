
SELECT LAST_DAY(T.DT_DIA) DT_APONTAMENTO, T.CD_DOC_IDENTF_CLIE,T.CD_TP_IDENTF_CLIE,    
(SELECT 'Análise: Regra ' || TO_CHAR(CD_REGRA) || ' - ' || NM_REGRA || '| Objetivo: ' || DS_REGRA || '|' FROM TB_REGRA WHERE CD_REGRA = 4014 AND CD_VERSAO_SISTEMA = 4) ||
'Cliente: ' ||  coalesce(T.NM_CLIE, 'Nome não informado') || '|' ||  
CASE T.CD_TP_IDENTF_CLIE   
	WHEN 2 THEN 'Tipo de Pessoa Física (CPF): ' || SUBSTR(T.CD_DOC_IDENTF_CLIE, 1, 3) || '.' || SUBSTR(T.CD_DOC_IDENTF_CLIE, 4, 3) || '.' || SUBSTR(T.CD_DOC_IDENTF_CLIE, 7, 3) || '-' || SUBSTR(T.CD_DOC_IDENTF_CLIE, 10, 2)   
	WHEN 3 THEN 'Tipo de Pessoa Jurídica (CNPJ): ' ||SUBSTR(T.CD_DOC_IDENTF_CLIE, 1, 2) || '.' || SUBSTR(T.CD_DOC_IDENTF_CLIE, 3, 3) || '.' || SUBSTR(T.CD_DOC_IDENTF_CLIE, 6, 3) || '/' || SUBSTR(T.CD_DOC_IDENTF_CLIE, 9, 4) || '-'  || SUBSTR(T.CD_DOC_IDENTF_CLIE, 13, 2)    
	ELSE T.CD_DOC_IDENTF_CLIE   
END   
|| '|' ||    
'Lote: ' || to_char(T.CD_LOTE) || '|' || 
'Dia de consolidação: ' || TO_CHAR(T.DT_DIA,'DD/MM/YYYY') || '|' ||   
'Valor consolidada no dia: ' || TO_CHAR(T.VL_TOTAL, 'L999G999G999G990D99') || '|'  ||   
'Quantidade de transações: ' || TO_CHAR(T.QT_TOTAL) || '|'  ||   
'Natureza da transação: Crédito | ' ||
'Tipo da transação: Depósito |'||  
'Forma da transação: Espécie |' ||
'É servidor público? :' || CASE FL_SERVIDOR_PUBLICO WHEN 1 THEN 'Sim |' ELSE 'Não |' END  || 
'É PEP? (DTEC-FLEX) :'  || CASE FL_PEP_DTEC_FLEX    WHEN 1 THEN 'Sim |' ELSE 'Não |' END  || 
'É PEP? (RU) :'         || CASE FL_PEP              WHEN 1 THEN 'Sim |' ELSE 'Não |' END  || 
COALESCE((SELECT DS_CAMPO_PARAM || ' (' || NM_CAMPO_PARAM || '):' || TO_CHAR(VL_PARAM, 'L999G999G999G990D99') FROM TB_REGRA_PARAMETRO WHERE CD_REGRA = 4014 AND CD_VERSAO_SISTEMA = 4 AND NM_CAMPO_PARAM = 'pm_ValorRelevante'),'Parâmetro não cadastrado|' ) || '|'
AS DS_INF_ANLSE  
FROM
(SELECT A.DT_DIA, A.CD_DOC_IDENTF_CLIE, A.CD_TP_IDENTF_CLIE, A.NM_CLIE, A.CD_LOTE, SUM(T.VL_OPER) VL_TOTAL, COUNT(*) QT_TOTAL, FL_SERVIDOR_PUBLICO, FL_PEP_DTEC_FLEX, FL_PEP
FROM TB_TRANS_ANLSE T
INNER JOIN
(SELECT DT_DIA, CD_DOC_IDENTF_CLIE, CD_TP_IDENTF_CLIE, NM_CLIE, CD_LOTE, FL_SERVIDOR_PUBLICO, FL_PEP_DTEC_FLEX, FL_PEP
 FROM (
  SELECT TRUNC(A.DT_TRANS) DT_DIA, A.CD_DOC_IDENTF_CLIE, A.CD_TP_IDENTF_CLIE, A.NM_CLIE, A.CD_LOTE
    ,CASE O.FL_SERVIDOR_PUBLICO WHEN 1   THEN 1 ELSE 0 END FL_SERVIDOR_PUBLICO
    ,CASE N.FL_PEP              WHEN 'S' THEN 1 ELSE 0 END FL_PEP_DTEC_FLEX
    ,CASE P.CD_DOC_IDENTF       WHEN A.CD_DOC_IDENTF_CLIE  THEN 1 ELSE 0 END FL_PEP
  FROM TB_TRANS_ANLSE A
  LEFT JOIN TB_CLIE_RENDA C ON A.CD_DOC_IDENTF_CLIE = C.CD_DOC_IDENTF_CLIE AND A.CD_TP_IDENTF_CLIE  = C.CD_TP_IDENTF_CLIE
  LEFT JOIN TB_SITUACAO_ATIVID O ON O.CD_SITUACAO_ATIVID = C.CD_SITUACAO_ATIVID
  LEFT JOIN TB_PPE P ON P.CD_DOC_IDENTF = A.CD_DOC_IDENTF_CLIE AND P.CD_TP_IDENTF = A.CD_TP_IDENTF_CLIE
  LEFT JOIN TB_NOTICIA_CLIE N ON 
          ((N.CD_DOC_IDENTF_CLIE = A.CD_DOC_IDENTF_CLIE AND N.CD_TP_IDENTF_CLIE  = A.CD_TP_IDENTF_CLIE)
		    OR
		    (A.NM_CLIE IS NOT NULL AND N.NM_ALVO IS NOT NULL AND N.NM_ALVO_FIEL IS NOT NULL AND
		    (UPPER(N.NM_ALVO) LIKE '%' || UPPER(A.NM_CLIE) || '%' OR UPPER(N.NM_ALVO_FIEL) LIKE '%' || UPPER(A.NM_CLIE) || '%'))
		  )         
  WHERE A.CD_LOTE = :cd_lote AND A.CD_SUBLOTE = :cd_sublote 
    AND A.CD_TP_PESSOA  = 'F'
    AND A.CD_NATUR_OPER = 1  /*credito*/
    AND A.CD_TP_OPER    = 4  /*depósito*/
    AND A.CD_FORMA_OPER = 7  /*especie*/
   GROUP BY TRUNC(A.DT_TRANS), A.CD_DOC_IDENTF_CLIE, A.CD_TP_IDENTF_CLIE, A.NM_CLIE, A.CD_LOTE, O.FL_SERVIDOR_PUBLICO, N.FL_PEP, P.CD_DOC_IDENTF
  ) A
 WHERE FL_SERVIDOR_PUBLICO = 1 OR FL_PEP_DTEC_FLEX = 1 OR FL_PEP = 1
) A
 ON   TRUNC(T.DT_TRANS)    = A.DT_DIA
  AND T.CD_DOC_IDENTF_CLIE = A.CD_DOC_IDENTF_CLIE
  AND T.CD_TP_IDENTF_CLIE  = A.CD_TP_IDENTF_CLIE
  AND CD_TP_PESSOA  = 'F'
  AND CD_NATUR_OPER = 1  /*credito*/
  AND CD_TP_OPER    = 4  /*depósito*/
  AND CD_FORMA_OPER = 7  /*especie*/
GROUP BY A.DT_DIA, A.CD_DOC_IDENTF_CLIE, A.CD_TP_IDENTF_CLIE, A.NM_CLIE, A.CD_LOTE, FL_SERVIDOR_PUBLICO, FL_PEP_DTEC_FLEX, FL_PEP ) T
WHERE VL_TOTAL >= (SELECT VL_PARAM FROM TB_REGRA_PARAMETRO WHERE CD_REGRA = 4014 AND CD_VERSAO_SISTEMA = 4 AND NM_CAMPO_PARAM = 'pm_ValorRelevante')

UNION ALL

SELECT LAST_DAY(T.DT_DIA) DT_APONTAMENTO, T.CD_DOC_IDENTF_CLIE,T.CD_TP_IDENTF_CLIE,    
(SELECT 'Análise: Regra ' || TO_CHAR(CD_REGRA) || ' - ' || NM_REGRA || '| Objetivo: ' || DS_REGRA || '|' FROM TB_REGRA WHERE CD_REGRA = 4014 AND CD_VERSAO_SISTEMA = 4) ||
'Cliente: ' ||  coalesce(T.NM_CLIE, 'Nome não informado') || '|' ||  
CASE T.CD_TP_IDENTF_CLIE   
	WHEN 2 THEN 'Tipo de Pessoa Física (CPF): ' || SUBSTR(T.CD_DOC_IDENTF_CLIE, 1, 3) || '.' || SUBSTR(T.CD_DOC_IDENTF_CLIE, 4, 3) || '.' || SUBSTR(T.CD_DOC_IDENTF_CLIE, 7, 3) || '-' || SUBSTR(T.CD_DOC_IDENTF_CLIE, 10, 2)   
	WHEN 3 THEN 'Tipo de Pessoa Jurídica (CNPJ): ' ||SUBSTR(T.CD_DOC_IDENTF_CLIE, 1, 2) || '.' || SUBSTR(T.CD_DOC_IDENTF_CLIE, 3, 3) || '.' || SUBSTR(T.CD_DOC_IDENTF_CLIE, 6, 3) || '/' || SUBSTR(T.CD_DOC_IDENTF_CLIE, 9, 4) || '-'  || SUBSTR(T.CD_DOC_IDENTF_CLIE, 13, 2)    
	ELSE T.CD_DOC_IDENTF_CLIE   
END   
|| '|' ||    
'Lote: ' || TO_CHAR(T.CD_LOTE)  || '|' ||
CASE WHEN T.CD_DOC_IDENTF_CONJUGE IS NOT NULL THEN
   '| Conjuge PEP: ' ||  coalesce(T.NM_CONJUGE, 'Nome não informado') ||   
   ', CPF ' || SUBSTR(T.CD_DOC_IDENTF_CONJUGE, 1, 3) || '.' || SUBSTR(T.CD_DOC_IDENTF_CONJUGE, 4, 3) || '.' || SUBSTR(T.CD_DOC_IDENTF_CONJUGE, 7, 3) || '-' || SUBSTR(T.CD_DOC_IDENTF_CONJUGE, 10, 2)   || '|' 
END ||   
CASE WHEN REPRESENTADOS IS NOT NULL THEN '| Cliente representa o(s) seguinte(s) PEP(s): |' || REPRESENTADOS END || 
CASE WHEN COLABORADORES IS NOT NULL THEN '| Estreito(s) colaboradore(s) do cliente é(são) PEP(s): |' || COLABORADORES END  ||  
CASE WHEN AMIGOS IS NOT NULL THEN '| Amigos de trabalho do cliente é(são) PEP(s): |' || AMIGOS END   
|| '|' || 
'Data de consolidação: ' || TO_CHAR(DT_DIA)  || '|' ||
'Valor consolidado: ' || TO_CHAR(VL_TOTAL, 'L999G999G999G990D99') || '|' ||
'Quantidade de transações: ' || TO_CHAR(QT_TOTAL) || '|' ||
'Natureza da transação: Crédito | ' ||
'Tipo da transação: Depósito |'||  
'Forma da transação: Espécie |' ||
COALESCE((SELECT DS_CAMPO_PARAM || ' (' || NM_CAMPO_PARAM || '):' || TO_CHAR(VL_PARAM, 'L999G999G999G990D99') FROM TB_REGRA_PARAMETRO WHERE CD_REGRA = 4014 AND CD_VERSAO_SISTEMA = 4 AND NM_CAMPO_PARAM = 'pm_ValorRelevante'),'Parâmetro não cadastrado|' ) || '|' ||
COALESCE((SELECT DS_CAMPO_PARAM || ' (' || NM_CAMPO_PARAM || '):' || TO_CHAR(VL_PARAM) FROM TB_REGRA_PARAMETRO WHERE CD_REGRA = 4014 AND CD_VERSAO_SISTEMA = 4 AND NM_CAMPO_PARAM = 'pm_QtdeEstreitoColaborador'),'Parâmetro não cadastrado|' ) || '|'  
AS DS_INF_ANLSE
FROM
(
SELECT A.DT_DIA, A.CD_DOC_IDENTF_CLIE, A.CD_TP_IDENTF_CLIE, A.NM_CLIE, A.NM_CONJUGE, A.CD_DOC_IDENTF_CONJUGE, A.CD_LOTE, A.REPRESENTADOS, A.COLABORADORES, A.AMIGOS, SUM(VL_OPER) VL_TOTAL, COUNT(*) QT_TOTAL
FROM TB_TRANS_ANLSE T
INNER JOIN
(
SELECT TRUNC(A.DT_TRANS) DT_DIA, A.CD_DOC_IDENTF_CLIE, A.CD_TP_IDENTF_CLIE, A.NM_CLIE, CO.AMIGOS,R.REPRESENTADOS,EC.COLABORADORES,
       MAX(A.NM_CONJUGE) NM_CONJUGE, MAX(A.CD_DOC_IDENTF_CONJUGE) CD_DOC_IDENTF_CONJUGE, A.CD_LOTE       
 FROM TB_TRANS_ANLSE A
 /* o cliente é o representante de um PEP?*/
 LEFT JOIN 
 (SELECT O.CD_DOC_IDENTF_REPRE, O.CD_TP_IDENTF_REPRE,
  (LISTAGG(O.NM_REPRESTD || ':' || O.CD_DOC_IDENTF_REPRESTD , '|') WITHIN GROUP (ORDER BY O.NM_REPRESTD asc))   REPRESENTADOS
  FROM
   (SELECT O.CD_DOC_IDENTF_REPRE, O.CD_TP_IDENTF_REPRE, O.CD_DOC_IDENTF_CLIE CD_DOC_IDENTF_REPRESTD, O.CD_TP_IDENTF_CLIE CD_TP_IDENTF_REPRESTD, O.NM_CLIE NM_REPRESTD
    FROM TB_TRANSMISSAO_ORDEM  O
    WHERE EXISTS 
       (SELECT 1 FROM TB_TRANS_ANLSE A WHERE A.CD_LOTE = :cd_lote AND A.CD_SUBLOTE = :cd_sublote 
        AND A.CD_NATUR_OPER = 1  /*credito*/
        AND A.CD_TP_OPER    = 4  /*depósito*/
        AND A.CD_FORMA_OPER = 7  /*especie*/
        AND O.CD_DOC_IDENTF_REPRE = A.CD_DOC_IDENTF_CLIE AND O.CD_TP_IDENTF_REPRE = A.CD_TP_IDENTF_CLIE) 
        AND (
         (EXISTS (SELECT 1 FROM TB_PPE C WHERE C.CD_DOC_IDENTF = O.CD_DOC_IDENTF_CLIE AND C.CD_TP_IDENTF = O.CD_TP_IDENTF_CLIE ))
          OR
         (EXISTS (SELECT 1 FROM TB_NOTICIA_CLIE N WHERE
            ((N.CD_DOC_IDENTF_CLIE = O.CD_DOC_IDENTF_CLIE AND N.CD_TP_IDENTF_CLIE  = O.CD_TP_IDENTF_CLIE)
		     OR
		     (O.NM_CLIE IS NOT NULL AND N.NM_ALVO IS NOT NULL AND N.NM_ALVO_FIEL IS NOT NULL AND
		     (UPPER(N.NM_ALVO) LIKE '%' || UPPER(O.NM_CLIE) || '%' OR UPPER(N.NM_ALVO_FIEL) LIKE '%' || UPPER(O.NM_CLIE) || '%'))
		     )         
          ))) 
  ) O GROUP BY O.CD_DOC_IDENTF_REPRE, O.CD_TP_IDENTF_REPRE          
  ) R  ON (R.CD_DOC_IDENTF_REPRE = A.CD_DOC_IDENTF_CLIE AND R.CD_TP_IDENTF_REPRE = A.CD_TP_IDENTF_CLIE)  
 LEFT JOIN /*amigo de trabalho PEP*/
 (SELECT O.CD_DOC_IDENTF_CLIE, O.CD_TP_IDENTF_CLIE, 
     LISTAGG('Empregador ' || CO.CD_DOC_IDENTF_TRAB || ': funcionário ' || CO.CD_DOC_IDENTF_CLIE , '|') WITHIN GROUP (ORDER BY CO.CD_DOC_IDENTF_TRAB asc)  AMIGOS
  FROM TB_COLABORADOR CO
  INNER JOIN
  (SELECT O.CD_DOC_IDENTF_TRAB, O.CD_TP_IDENTF_TRAB, O.CD_DOC_IDENTF_CLIE, O.CD_TP_IDENTF_CLIE
    FROM TB_COLABORADOR  O
    WHERE EXISTS 
       (SELECT 1 FROM TB_TRANS_ANLSE A WHERE A.CD_LOTE = :cd_lote AND A.CD_SUBLOTE = :cd_sublote 
        AND A.CD_NATUR_OPER = 1  /*credito*/
        AND A.CD_TP_OPER    = 4  /*depósito*/
        AND A.CD_FORMA_OPER = 7  /*especie*/
        AND O.CD_DOC_IDENTF_CLIE = A.CD_DOC_IDENTF_CLIE AND O.CD_TP_IDENTF_CLIE = A.CD_TP_IDENTF_CLIE)
    ) O
    ON (O.CD_DOC_IDENTF_TRAB = CO.CD_DOC_IDENTF_TRAB AND O.CD_TP_IDENTF_TRAB = CO.CD_TP_IDENTF_TRAB)
  WHERE         
  (EXISTS (SELECT 1 FROM TB_PPE C WHERE C.CD_DOC_IDENTF = CO.CD_DOC_IDENTF_CLIE AND C.CD_TP_IDENTF = CO.CD_TP_IDENTF_CLIE ))
   OR
  (EXISTS (SELECT 1 FROM TB_NOTICIA_CLIE N WHERE N.CD_DOC_IDENTF_CLIE = CO.CD_DOC_IDENTF_CLIE AND N.CD_TP_IDENTF_CLIE  = CO.CD_TP_IDENTF_CLIE))  
  GROUP BY O.CD_DOC_IDENTF_CLIE, O.CD_TP_IDENTF_CLIE
) CO ON (CO.CD_DOC_IDENTF_CLIE = A.CD_DOC_IDENTF_CLIE AND CO.CD_TP_IDENTF_CLIE = A.CD_TP_IDENTF_CLIE)  
  
 LEFT JOIN /* o cliente tem um estreito colaborador que é PEP*/
 (SELECT EC.CD_DOC_IDENTF_CLIE, EC.CD_TP_IDENTF_CLIE, 
 CASE WHEN MAX(EC.CD_DOC_IDENTF_COLABORADOR) IS NOT NULL THEN LISTAGG(EC.CD_DOC_IDENTF_COLABORADOR || ':' || TO_CHAR(EC.QT_TOTAL)  || ' transações em 6 meses calendários.', '|') WITHIN GROUP (ORDER BY  EC.CD_DOC_IDENTF_COLABORADOR asc) END COLABORADORES       
 FROM (
 SELECT CD_VARIAVEL_PRIMEIRA CD_DOC_IDENTF_CLIE, CD_VARIAVEL_SEGUNDA CD_TP_IDENTF_CLIE, CD_VARIAVEL_TERCEIRA CD_DOC_IDENTF_COLABORADOR, CD_VARIAVEL_QUARTA CD_TP_IDENTF_COLABORADOR, SUM(QT_TOTAL) QT_TOTAL, SUM(VL_TOTAL) VL_TOTAL
  FROM TB_PERFIL_MES_CALENDARIO M
  WHERE CD_IDENTF_PERFIL = 101 
    AND EXISTS
      (SELECT 1 FROM TB_TRANS_ANLSE S
        WHERE S.CD_LOTE = :cd_lote AND S.CD_SUBLOTE = :cd_sublote 
        AND S.CD_NATUR_OPER = 1  /*credito*/
        AND S.CD_TP_OPER    = 4  /*depósito*/
        AND S.CD_FORMA_OPER = 7  /*especie*/  
        AND (S.CD_DOC_IDENTF_CLIE = M.CD_VARIAVEL_PRIMEIRA AND S.CD_TP_IDENTF_CLIE = M.CD_VARIAVEL_SEGUNDA)
       )
     AND (
         (EXISTS (SELECT 1 FROM TB_PPE C WHERE C.CD_DOC_IDENTF = M.CD_VARIAVEL_TERCEIRA AND C.CD_TP_IDENTF = M.CD_VARIAVEL_QUARTA))
          OR
         (EXISTS (SELECT 1 FROM TB_NOTICIA_CLIE N WHERE N.CD_DOC_IDENTF_CLIE = M.CD_VARIAVEL_TERCEIRA AND N.CD_TP_IDENTF_CLIE  = M.CD_VARIAVEL_QUARTA))
          )         
    GROUP BY CD_VARIAVEL_PRIMEIRA, CD_VARIAVEL_SEGUNDA, CD_VARIAVEL_TERCEIRA, CD_VARIAVEL_QUARTA
    HAVING SUM(QT_TOTAL) > (SELECT VL_PARAM FROM TB_REGRA_PARAMETRO WHERE CD_REGRA = 4014 AND CD_VERSAO_SISTEMA = 4 AND NM_CAMPO_PARAM = 'pm_QtdeEstreitoColaborador')  
    ) EC
    GROUP BY EC.CD_DOC_IDENTF_CLIE, EC.CD_TP_IDENTF_CLIE
  ) EC ON A.CD_DOC_IDENTF_CLIE  = EC.CD_DOC_IDENTF_CLIE  AND A.CD_TP_IDENTF_CLIE = EC.CD_TP_IDENTF_CLIE
    
 WHERE A.CD_LOTE = :cd_lote AND A.CD_SUBLOTE = :cd_sublote 
    AND A.CD_NATUR_OPER = 1  /*credito*/
    AND A.CD_TP_OPER    = 4  /*depósito*/
    AND A.CD_FORMA_OPER = 7  /*especie*/  
GROUP BY TRUNC(DT_TRANS), A.CD_DOC_IDENTF_CLIE, A.CD_TP_IDENTF_CLIE, A.NM_CLIE, A.CD_LOTE, CO.AMIGOS, R.REPRESENTADOS, EC.COLABORADORES
) A
 ON   TRUNC(T.DT_TRANS)    = A.DT_DIA
  AND T.CD_DOC_IDENTF_CLIE = A.CD_DOC_IDENTF_CLIE
  AND T.CD_TP_IDENTF_CLIE  = A.CD_TP_IDENTF_CLIE
WHERE T.CD_NATUR_OPER = 1  /*credito*/
  AND T.CD_TP_OPER    = 4  /*depósito*/
  AND T.CD_FORMA_OPER = 7  /*especie*/
  AND 
     (A.REPRESENTADOS IS NOT NULL
      OR 
      A.COLABORADORES IS NOT NULL
      OR
      A.AMIGOS IS NOT NULL
      OR
      (
         (EXISTS (SELECT 1 FROM TB_PPE C WHERE C.CD_DOC_IDENTF = A.CD_DOC_IDENTF_CONJUGE ))
          OR
         (EXISTS (SELECT 1 FROM TB_NOTICIA_CLIE N WHERE
            ((N.CD_DOC_IDENTF_CLIE = A.CD_DOC_IDENTF_CONJUGE)
		     OR
		     (A.NM_CONJUGE IS NOT NULL AND N.NM_ALVO IS NOT NULL AND N.NM_ALVO_FIEL IS NOT NULL AND
		     (UPPER(N.NM_ALVO) LIKE '%' || UPPER(A.NM_CONJUGE) || '%' OR UPPER(N.NM_ALVO_FIEL) LIKE '%' || UPPER(A.NM_CONJUGE) || '%'))
		     )         
          )))    
      )
 GROUP BY A.DT_DIA, A.CD_DOC_IDENTF_CLIE, A.CD_TP_IDENTF_CLIE, A.NM_CLIE, A.NM_CONJUGE, A.CD_DOC_IDENTF_CONJUGE, A.CD_LOTE, A.REPRESENTADOS, A.COLABORADORES, A.AMIGOS, A.COLABORADORES 
) T
WHERE VL_TOTAL >= (SELECT VL_PARAM FROM TB_REGRA_PARAMETRO WHERE CD_REGRA = 4014 AND CD_VERSAO_SISTEMA = 4 AND NM_CAMPO_PARAM = 'pm_ValorRelevante')

