
SELECT LAST_DAY(TRUNC(T.DT_TRANS)) DT_APONTAMENTO,  T.CD_DOC_IDENTF_CLIE, T.CD_TP_IDENTF_CLIE,  
(SELECT 'Análise: Regra ' || TO_CHAR(CD_REGRA) || ' - ' || NM_REGRA || '| Objetivo: ' || DS_REGRA || '|' FROM TB_REGRA WHERE CD_REGRA = 4027 AND CD_VERSAO_SISTEMA = 4) ||
'Cliente: ' ||  T.NM_CLIE || '|' ||   
CASE T.CD_TP_IDENTF_CLIE    
	WHEN 2 THEN 'Tipo de Pessoa Física (CPF): ' || SUBSTR(T.CD_DOC_IDENTF_CLIE, 1, 3) || '.' || SUBSTR(T.CD_DOC_IDENTF_CLIE, 4, 3) || '.' || SUBSTR(T.CD_DOC_IDENTF_CLIE, 7, 3) || '-' || SUBSTR(T.CD_DOC_IDENTF_CLIE, 10, 2)    
	WHEN 3 THEN 'Tipo de Pessoa Jurídica (CNPJ): ' ||SUBSTR(T.CD_DOC_IDENTF_CLIE, 1, 2) || '.' || SUBSTR(T.CD_DOC_IDENTF_CLIE, 3, 3) || '.' || SUBSTR(T.CD_DOC_IDENTF_CLIE, 6, 3) || '/' || SUBSTR(T.CD_DOC_IDENTF_CLIE, 9, 4) || '-'  || SUBSTR(T.CD_DOC_IDENTF_CLIE, 13, 2)     
	ELSE T.CD_DOC_IDENTF_CLIE    
END    
|| '|' ||   
'Data da transação: ' || TO_CHAR(DT_TRANS,'DD/MM/YYYY') ||  '|' ||   
'Lote: ' || TO_CHAR(CD_LOTE) ||  '|' ||   
CASE FL_MOVTA_PROC WHEN 1 THEN 'Transação movimentação por procuração' END ||  '|' || 
CASE WHEN REPRE IS NOT NULL THEN 'Cliente representado por: ' || REPRE END ||  '|'   
AS DS_INF_ANLSE  
FROM (

SELECT T.CD_LOTE, T.CD_DOC_IDENTF_CLIE, T.CD_TP_IDENTF_CLIE, T.NM_CLIE, DT_TRANS, T.FL_MOVTA_PROC
,LISTAGG(
CASE TO1.CD_TP_IDENTF_REPRE  
	WHEN 2 THEN 'CPF- ' || SUBSTR(TO1.CD_DOC_IDENTF_REPRE, 1, 3) || '.' || SUBSTR(TO1.CD_DOC_IDENTF_REPRE, 4, 3) || '.' || SUBSTR(TO1.CD_DOC_IDENTF_REPRE, 7, 3) || '-' || SUBSTR(TO1.CD_DOC_IDENTF_REPRE, 10, 2)  
	WHEN 3 THEN 'CNPJ- ' ||SUBSTR(TO1.CD_DOC_IDENTF_REPRE, 1, 2) || '.' || SUBSTR(TO1.CD_DOC_IDENTF_REPRE, 3, 3) || '.' || SUBSTR(TO1.CD_DOC_IDENTF_REPRE, 6, 3) || '/' || SUBSTR(TO1.CD_DOC_IDENTF_REPRE, 9, 4) || '-'  || SUBSTR(TO1.CD_DOC_IDENTF_REPRE, 13, 2)   
	ELSE TO1.CD_DOC_IDENTF_REPRE  
END,  ', ') WITHIN GROUP (ORDER BY TO1.CD_DOC_IDENTF_REPRE desc) REPRE
FROM 
(SELECT T1.CD_LOTE, T1.CD_DOC_IDENTF_CLIE, T1.CD_TP_IDENTF_CLIE, T1.NM_CLIE, trunc(DT_TRANS) DT_TRANS, COALESCE(FL_MOVTA_PROC,0) FL_MOVTA_PROC
   FROM TB_TRANS_ANLSE T1  
  WHERE T1.CD_TP_PESSOA = 'F'  
    AND T1.CD_LOTE = :cd_lote    
    AND T1.CD_SUBLOTE = :cd_sublote
    GROUP BY T1.CD_LOTE, T1.CD_DOC_IDENTF_CLIE, T1.CD_TP_IDENTF_CLIE, T1.NM_CLIE, trunc(DT_TRANS), COALESCE(FL_MOVTA_PROC,0) 
 ) T  
LEFT JOIN TB_TRANSMISSAO_ORDEM TO1 
   ON TO1.CD_DOC_IDENTF_CLIE = T.CD_DOC_IDENTF_CLIE  
  AND TO1.CD_TP_IDENTF_CLIE = T.CD_TP_IDENTF_CLIE  
GROUP BY T.CD_LOTE, T.CD_DOC_IDENTF_CLIE, T.CD_TP_IDENTF_CLIE, T.NM_CLIE, DT_TRANS, T.FL_MOVTA_PROC
) T
WHERE REPRE IS NOT NULL
  OR FL_MOVTA_PROC = 1
  





